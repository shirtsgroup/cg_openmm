

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>cg_openmm.simulation.rep_exch &mdash; cg_openmm  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> cg_openmm
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Introduction:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">Getting Started</a></li>
</ul>
<p class="caption"><span class="caption-text">CGModel class:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../cgmodel_class.html">CGModel class</a></li>
</ul>
<p class="caption"><span class="caption-text">API documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API Documentation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">cg_openmm</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>cg_openmm.simulation.rep_exch</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for cg_openmm.simulation.rep_exch</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">pyplot</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_pdf</span> <span class="kn">import</span> <span class="n">PdfPages</span>
<span class="kn">from</span> <span class="nn">simtk</span> <span class="kn">import</span> <span class="n">unit</span>
<span class="kn">import</span> <span class="nn">openmmtools</span>
<span class="kn">from</span> <span class="nn">cg_openmm.utilities.util</span> <span class="kn">import</span> <span class="n">set_box_vectors</span><span class="p">,</span> <span class="n">get_box_vectors</span>
<span class="kn">from</span> <span class="nn">simtk.openmm.app.pdbfile</span> <span class="kn">import</span> <span class="n">PDBFile</span>
<span class="kn">from</span> <span class="nn">simtk.openmm.app.dcdfile</span> <span class="kn">import</span> <span class="n">DCDFile</span>
<span class="kn">from</span> <span class="nn">mdtraj.formats</span> <span class="kn">import</span> <span class="n">PDBTrajectoryFile</span>
<span class="kn">from</span> <span class="nn">mdtraj</span> <span class="kn">import</span> <span class="n">Topology</span>
<span class="kn">from</span> <span class="nn">pymbar</span> <span class="kn">import</span> <span class="n">timeseries</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">openmmtools.multistate</span> <span class="kn">import</span> <span class="n">MultiStateReporter</span><span class="p">,</span> <span class="n">MultiStateSampler</span><span class="p">,</span> <span class="n">ReplicaExchangeSampler</span>
<span class="kn">from</span> <span class="nn">openmmtools.multistate</span> <span class="kn">import</span> <span class="n">ReplicaExchangeAnalyzer</span>

<span class="c1"># quiet down some citation spam</span>
<span class="n">MultiStateSampler</span><span class="o">.</span><span class="n">_global_citation_silence</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">kB</span> <span class="o">=</span> <span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">MOLAR_GAS_CONSTANT_R</span><span class="p">)</span><span class="o">.</span><span class="n">in_units_of</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">kilojoule</span> <span class="o">/</span> <span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">kelvin</span> <span class="o">*</span> <span class="n">unit</span><span class="o">.</span><span class="n">mole</span><span class="p">))</span>

<div class="viewcode-block" id="make_replica_dcd_files"><a class="viewcode-back" href="../../../index.html#cg_openmm.simulation.rep_exch.make_replica_dcd_files">[docs]</a><span class="k">def</span> <span class="nf">make_replica_dcd_files</span><span class="p">(</span><span class="n">topology</span><span class="p">,</span> <span class="n">replica_positions</span><span class="p">,</span> <span class="n">timestep</span><span class="p">,</span> <span class="n">time_interval</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="n">frame_begin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make dcd files from replica exchange simulation trajectory data</span>
<span class="sd">    </span>
<span class="sd">    :param topology: OpenMM Topology</span>
<span class="sd">    :type topology: `Topology() &lt;https://simtk.org/api_docs/openmm/api4_1/python/classsimtk_1_1openmm_1_1app_1_1topology_1_1Topology.html&gt;`_</span>

<span class="sd">    :param replica_positions: Positions array for the replica exchange data for which we will write dcd files</span>
<span class="sd">    :type replica_positions: `Quantity() &lt;http://docs.openmm.org/development/api-python/generated/simtk.unit.quantity.Quantity.html&gt;`_ ( np.array( [n_replicas,cgmodel.num_beads,3] ), simtk.unit )</span>

<span class="sd">    :param timestep: Time step used in the simulation</span>
<span class="sd">    :type timestep: `Quantity() &lt;http://docs.openmm.org/development/api-python/generated/simtk.unit.quantity.Quantity.html&gt;` float * simtk.unit</span>
<span class="sd">    </span>
<span class="sd">    :param time_interval: frequency, in number of time steps, at which positions were recorded</span>
<span class="sd">    :type time_interval: int</span>
<span class="sd">    </span>
<span class="sd">    :param output_directory: Path to which we will write the output (default=&quot;output&quot;)</span>
<span class="sd">    :type output_directory: str</span>
<span class="sd">    </span>
<span class="sd">    :param frame_begin: Frame at which to start writing the dcd trajectory (default=0)</span>
<span class="sd">    :type frame_begin: int</span>
<span class="sd">    </span>
<span class="sd">    :param stride: advance by this many time intervals when writing dcd trajectories (default=1)</span>
<span class="sd">    :type stride: int </span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">file_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">replica_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">replica_positions</span><span class="p">)):</span>
        <span class="n">replica_trajectory</span> <span class="o">=</span> <span class="n">replica_positions</span><span class="p">[</span><span class="n">replica_index</span><span class="p">][</span><span class="n">frame_begin</span><span class="p">::</span><span class="n">stride</span><span class="p">]</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;replica_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">replica_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.dcd&quot;</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span>
        <span class="n">dcd_file</span> <span class="o">=</span> <span class="n">DCDFile</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">topology</span><span class="p">,</span> <span class="n">timestep</span><span class="p">,</span> <span class="n">firstStep</span><span class="o">=</span><span class="n">frame_begin</span><span class="p">,</span><span class="n">interval</span><span class="o">=</span><span class="n">time_interval</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">positions</span> <span class="ow">in</span> <span class="n">replica_trajectory</span><span class="p">:</span>
            <span class="n">DCDFile</span><span class="o">.</span><span class="n">writeModel</span><span class="p">(</span><span class="n">dcd_file</span><span class="p">,</span> <span class="n">positions</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">file_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">file_list</span></div>
    

<div class="viewcode-block" id="make_replica_pdb_files"><a class="viewcode-back" href="../../../index.html#cg_openmm.simulation.rep_exch.make_replica_pdb_files">[docs]</a><span class="k">def</span> <span class="nf">make_replica_pdb_files</span><span class="p">(</span><span class="n">topology</span><span class="p">,</span> <span class="n">replica_positions</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="n">frame_begin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make PDB files from replica exchange simulation trajectory data</span>
<span class="sd">    </span>
<span class="sd">    :param topology: OpenMM Topology</span>
<span class="sd">    :type topology: `Topology() &lt;https://simtk.org/api_docs/openmm/api4_1/python/classsimtk_1_1openmm_1_1app_1_1topology_1_1Topology.html&gt;`_</span>
<span class="sd">    </span>
<span class="sd">    :param replica_positions: Positions array for the replica exchange data for which we will write PDB files</span>
<span class="sd">    :type replica_positions: `Quantity() &lt;http://docs.openmm.org/development/api-python/generated/simtk.unit.quantity.Quantity.html&gt;`_ ( np.array( [n_replicas,cgmodel.num_beads,3] ), simtk.unit )</span>

<span class="sd">    :param output_directory: Path to which we will write the output (default=&quot;output&quot;)</span>
<span class="sd">    :type output_directory: str    </span>
<span class="sd">    </span>
<span class="sd">    :param frame_begin: Frame at which to start writing the pdb trajectory (default=0)</span>
<span class="sd">    :type frame_begin: int    </span>
<span class="sd">    </span>
<span class="sd">    :param stride: advance by this many frames when writing pdb trajectories (default=1)</span>
<span class="sd">    :type stride: int</span>
<span class="sd">    </span>
<span class="sd">    :returns:</span>
<span class="sd">        - file_list ( List( str ) ) - A list of names for the files that were written</span>

<span class="sd">    :Example:</span>

<span class="sd">    &gt;&gt;&gt; from foldamers.cg_model.cgmodel import CGModel</span>
<span class="sd">    &gt;&gt;&gt; from cg_openmm.simulation.rep_exch import *</span>
<span class="sd">    &gt;&gt;&gt; cgmodel = CGModel()</span>
<span class="sd">    &gt;&gt;&gt; replica_energies,replica_positions,replica_state_indices = run_replica_exchange(cgmodel.topology,cgmodel.system,cgmodel.positions)</span>
<span class="sd">    &gt;&gt;&gt; pdb_file_list = make_replica_pdb_files(cgmodel.topology,replica_positions)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">file_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">replica_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">replica_positions</span><span class="p">)):</span>
        <span class="n">replica_trajectory</span> <span class="o">=</span> <span class="n">replica_positions</span><span class="p">[</span><span class="n">replica_index</span><span class="p">][</span><span class="n">frame_begin</span><span class="p">::</span><span class="n">stride</span><span class="p">]</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;replica_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">replica_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">PDBFile</span><span class="o">.</span><span class="n">writeHeader</span><span class="p">(</span><span class="n">topology</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
        <span class="n">modelIndex</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">positions</span> <span class="ow">in</span> <span class="n">replica_trajectory</span><span class="p">:</span>
            <span class="n">PDBFile</span><span class="o">.</span><span class="n">writeModel</span><span class="p">(</span><span class="n">topology</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">,</span> <span class="n">modelIndex</span><span class="o">=</span><span class="n">modelIndex</span><span class="p">)</span>
        <span class="n">PDBFile</span><span class="o">.</span><span class="n">writeFooter</span><span class="p">(</span><span class="n">topology</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">file_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">file_list</span></div>
    

<div class="viewcode-block" id="make_state_dcd_files"><a class="viewcode-back" href="../../../index.html#cg_openmm.simulation.rep_exch.make_state_dcd_files">[docs]</a><span class="k">def</span> <span class="nf">make_state_dcd_files</span><span class="p">(</span><span class="n">topology</span><span class="p">,</span> <span class="n">replica_positions</span><span class="p">,</span> <span class="n">replica_state_indices</span><span class="p">,</span> <span class="n">timestep</span><span class="p">,</span> <span class="n">time_interval</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="n">frame_begin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make dcd files from replica exchange simulation trajectory data</span>
<span class="sd">    </span>
<span class="sd">    :param topology: OpenMM Topology</span>
<span class="sd">    :type topology: `Topology() &lt;https://simtk.org/api_docs/openmm/api4_1/python/classsimtk_1_1openmm_1_1app_1_1topology_1_1Topology.html&gt;`_</span>

<span class="sd">    :param replica_positions: Positions array for the replica exchange data for which we will write dcd files</span>
<span class="sd">    :type replica_positions: `Quantity() &lt;http://docs.openmm.org/development/api-python/generated/simtk.unit.quantity.Quantity.html&gt;`_ ( np.array( [n_replicas,cgmodel.num_beads,3] ), simtk.unit )</span>

<span class="sd">    :param replica_state_indices: The thermodynamic state assignments for all replicas at all (printed) time steps</span>
<span class="sd">    :type replica_state_indices: ( np.int64( [number_replicas,number_simulation_steps] ), simtk.unit )     </span>
<span class="sd">    </span>
<span class="sd">    :param timestep: Time step used in the simulation</span>
<span class="sd">    :type timestep: `Quantity() &lt;http://docs.openmm.org/development/api-python/generated/simtk.unit.quantity.Quantity.html&gt;` float * simtk.unit</span>
<span class="sd">    </span>
<span class="sd">    :param time_interval: frequency, in number of time steps, at which positions were recorded</span>
<span class="sd">    :type time_interval: int</span>
<span class="sd">    </span>
<span class="sd">    :param output_directory: Path to which we will write the output (default=&quot;output&quot;)</span>
<span class="sd">    :type output_directory: str</span>
<span class="sd">    </span>
<span class="sd">    :param frame_begin: Frame at which to start writing the dcd trajectory (default=0)</span>
<span class="sd">    :type frame_begin: int</span>
<span class="sd">    </span>
<span class="sd">    :param stride: advance by this many time intervals when writing dcd trajectories (default=1)</span>
<span class="sd">    :type stride: int </span>
<span class="sd">    </span>
<span class="sd">    :param center: align the center of mass of each structure in the discontinuous state trajectory (default=True)</span>
<span class="sd">    :type center: Boolean</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">file_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">state_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">replica_positions</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">replica_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">replica_positions</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">replica_state_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])):</span>
            <span class="c1"># For each frame, assign replica_positions to state positions</span>
            <span class="n">state_positions</span><span class="p">[</span><span class="n">replica_state_indices</span><span class="p">[</span><span class="n">replica_index</span><span class="p">,</span><span class="n">frame</span><span class="p">],</span><span class="n">frame</span><span class="p">,:,:]</span><span class="o">=</span><span class="n">replica_positions</span><span class="p">[</span><span class="n">replica_index</span><span class="p">][</span><span class="n">frame</span><span class="p">]</span>
        
    <span class="k">for</span> <span class="n">state_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">replica_positions</span><span class="p">)):</span>
        <span class="n">state_trajectory</span> <span class="o">=</span> <span class="n">state_positions</span><span class="p">[</span><span class="n">state_index</span><span class="p">][</span><span class="n">frame_begin</span><span class="p">::</span><span class="n">stride</span><span class="p">]</span>
    
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;state_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">state_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.dcd&quot;</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span>
        <span class="n">dcd_file</span> <span class="o">=</span> <span class="n">DCDFile</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">topology</span><span class="p">,</span> <span class="n">timestep</span><span class="p">,</span> <span class="n">firstStep</span><span class="o">=</span><span class="n">frame_begin</span><span class="p">,</span><span class="n">interval</span><span class="o">=</span><span class="n">time_interval</span><span class="p">)</span>
        
        <span class="c1">#***Note: if we have different masses for particle types, need to update this</span>
        <span class="k">if</span> <span class="n">center</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="n">center_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">state_trajectory</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">center_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">state_trajectory</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">center_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">state_trajectory</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">2</span><span class="p">])</span>
        
        <span class="k">for</span> <span class="n">positions</span> <span class="ow">in</span> <span class="n">state_trajectory</span><span class="p">[::</span><span class="n">stride</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">center</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                <span class="n">positions</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">center_x</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">positions</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">positions</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">center_y</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">positions</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">positions</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">center_z</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">positions</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]))</span>
                
            <span class="c1"># Add the units consistent with replica_energies</span>
            <span class="n">positions</span> <span class="o">*=</span> <span class="n">replica_positions</span><span class="o">.</span><span class="n">unit</span>
            <span class="n">DCDFile</span><span class="o">.</span><span class="n">writeModel</span><span class="p">(</span><span class="n">dcd_file</span><span class="p">,</span> <span class="n">positions</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">file_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">file_list</span></div>
    
    
<div class="viewcode-block" id="make_state_pdb_files"><a class="viewcode-back" href="../../../index.html#cg_openmm.simulation.rep_exch.make_state_pdb_files">[docs]</a><span class="k">def</span> <span class="nf">make_state_pdb_files</span><span class="p">(</span><span class="n">topology</span><span class="p">,</span> <span class="n">replica_positions</span><span class="p">,</span> <span class="n">replica_state_indices</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="n">frame_begin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make PDB files by state from replica exchange simulation trajectory data.</span>
<span class="sd">    Note: these are discontinuous trajectories with constant temperature state.</span>
<span class="sd">    </span>
<span class="sd">    :param topology: OpenMM Topology</span>
<span class="sd">    :type topology: `Topology() &lt;https://simtk.org/api_docs/openmm/api4_1/python/classsimtk_1_1openmm_1_1app_1_1topology_1_1Topology.html&gt;`_</span>
<span class="sd">    </span>
<span class="sd">    :param replica_positions: Positions array for the replica exchange data for which we will write PDB files</span>
<span class="sd">    :type replica_positions: `Quantity() &lt;http://docs.openmm.org/development/api-python/generated/simtk.unit.quantity.Quantity.html&gt;`_ ( np.array( [n_replicas,cgmodel.num_beads,3] ), simtk.unit )</span>

<span class="sd">    :param replica_state_indices: The thermodynamic state assignments for all replicas at all (printed) time steps</span>
<span class="sd">    :type replica_state_indices: ( np.int64( [number_replicas,number_simulation_steps] ), simtk.unit ) </span>
<span class="sd">    </span>
<span class="sd">    :param output_directory: Path to which we will write the output (default=&quot;output&quot;)</span>
<span class="sd">    :type output_directory: str    </span>
<span class="sd">    </span>
<span class="sd">    :param frame_begin: Frame at which to start writing the pdb trajectory (default=0)</span>
<span class="sd">    :type frame_begin: int    </span>
<span class="sd">    </span>
<span class="sd">    :param stride: advance by this many frames when writing pdb trajectories (default=1)</span>
<span class="sd">    :type stride: int   </span>

<span class="sd">    :param center: align the center of mass of each structure in the discontinuous state trajectory (default=True)</span>
<span class="sd">    :type center: Boolean</span>
<span class="sd">    </span>
<span class="sd">    :returns:</span>
<span class="sd">        - file_list ( List( str ) ) - A list of names for the files that were written</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">file_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">state_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">replica_positions</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">replica_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">replica_positions</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">replica_state_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])):</span>
            <span class="c1"># For each frame, assign replica_positions to state positions</span>
            <span class="n">state_positions</span><span class="p">[</span><span class="n">replica_state_indices</span><span class="p">[</span><span class="n">replica_index</span><span class="p">,</span><span class="n">frame</span><span class="p">],</span><span class="n">frame</span><span class="p">,:,:]</span><span class="o">=</span><span class="n">replica_positions</span><span class="p">[</span><span class="n">replica_index</span><span class="p">][</span><span class="n">frame</span><span class="p">]</span>
        
    <span class="k">for</span> <span class="n">state_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">replica_positions</span><span class="p">)):</span>
        <span class="n">state_trajectory</span> <span class="o">=</span> <span class="n">state_positions</span><span class="p">[</span><span class="n">state_index</span><span class="p">]</span>
    
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;state_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">state_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>

        <span class="n">PDBFile</span><span class="o">.</span><span class="n">writeHeader</span><span class="p">(</span><span class="n">topology</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
        <span class="n">modelIndex</span> <span class="o">=</span> <span class="mi">1</span>
        
        <span class="c1">#***Note: if we have different masses for particle types, need to update this</span>
        <span class="k">if</span> <span class="n">center</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="n">center_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">state_trajectory</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">center_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">state_trajectory</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">center_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">state_trajectory</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">2</span><span class="p">])</span>
        
        <span class="k">for</span> <span class="n">positions</span> <span class="ow">in</span> <span class="n">state_trajectory</span><span class="p">[::</span><span class="n">stride</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">center</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                <span class="n">positions</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">center_x</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">positions</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">positions</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">center_y</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">positions</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">positions</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">center_z</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">positions</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]))</span>
                
            <span class="c1"># Add the units consistent with replica_energies, such that PDBFile will write in angstroms.</span>
            <span class="n">positions</span> <span class="o">*=</span> <span class="n">replica_positions</span><span class="o">.</span><span class="n">unit</span>
            <span class="n">PDBFile</span><span class="o">.</span><span class="n">writeModel</span><span class="p">(</span><span class="n">topology</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">,</span> <span class="n">modelIndex</span><span class="o">=</span><span class="n">modelIndex</span><span class="p">)</span>
        <span class="n">PDBFile</span><span class="o">.</span><span class="n">writeFooter</span><span class="p">(</span><span class="n">topology</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">file_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">file_list</span></div>


<div class="viewcode-block" id="process_replica_exchange_data"><a class="viewcode-back" href="../../../index.html#cg_openmm.simulation.rep_exch.process_replica_exchange_data">[docs]</a><span class="k">def</span> <span class="nf">process_replica_exchange_data</span><span class="p">(</span>
    <span class="n">output_data</span><span class="o">=</span><span class="s2">&quot;output.nc&quot;</span><span class="p">,</span> <span class="n">output_directory</span><span class="o">=</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="n">series_per_page</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">write_data_file</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">detect_equilibration</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot_production_only</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read replica exchange simulation data.</span>
<span class="sd">    </span>
<span class="sd">    :param system: OpenMM system object, default = None</span>
<span class="sd">    :type system: `System() &lt;https://simtk.org/api_docs/openmm/api4_1/python/classsimtk_1_1openmm_1_1openmm_1_1System.html&gt;`_</span>
<span class="sd">    </span>
<span class="sd">    :param temperature_list: List of temperatures that will be used to define different replicas (thermodynamics states), default = None</span>
<span class="sd">    :type temperature_list: List( `SIMTK &lt;https://simtk.org/&gt;`_ `Unit() &lt;http://docs.openmm.org/7.1.0/api-python/generated/simtk.unit.unit.Unit.html&gt;`_ * number_replicas )</span>

<span class="sd">    :param output_data: Path to the output data for a NetCDF-formatted file containing replica exchange simulation data, default = None</span>
<span class="sd">    :type output_data: str</span>

<span class="sd">    :param series_per_page: number of data series to plot per pdf page (default=6)</span>
<span class="sd">    :type series_per_page: int</span>
<span class="sd">    </span>
<span class="sd">    :param write_data_file: Option to write a text data file containing the state_energies array (default=True)</span>
<span class="sd">    :type write_data_file: Boolean</span>
<span class="sd">    </span>
<span class="sd">    :param detect_equilibration: Option to determine the frame at which the production region begins (default=True)</span>
<span class="sd">    :type detect_equilibration: Boolean</span>
<span class="sd">    </span>
<span class="sd">    :param plot_production_only: Option to plot only the production region, as determined from pymbar detectEquilibration (default=False)</span>
<span class="sd">    :type plot_production_only: Boolean    </span>

<span class="sd">    :returns:</span>
<span class="sd">        - replica_energies ( `Quantity() &lt;http://docs.openmm.org/development/api-python/generated/simtk.unit.quantity.Quantity.html&gt;`_ ( np.float( [number_replicas,number_simulation_steps] ), simtk.unit ) ) - The potential energies for all replicas at all (printed) time steps</span>
<span class="sd">        - replica_positions ( `Quantity() &lt;http://docs.openmm.org/development/api-python/generated/simtk.unit.quantity.Quantity.html&gt;`_ ( np.float( [number_replicas,number_simulation_steps,cgmodel.num_beads,3] ), simtk.unit ) ) - The positions for all replicas at all (printed) time steps</span>
<span class="sd">        - replica_state_indices ( np.int64( [number_replicas,number_simulation_steps] ), simtk.unit ) - The thermodynamic state assignments for all replicas at all (printed) time steps</span>
<span class="sd">        - production_start ( int - The frame at which the production region begins for all replicas, as determined from pymbar detectEquilibration</span>
<span class="sd">        - max_sample_spacing ( int - The number of frames between uncorrelated state energies )</span>
<span class="sd">    :Example:</span>

<span class="sd">    &gt;&gt;&gt; from foldamers.cg_model.cgmodel import CGModel</span>
<span class="sd">    &gt;&gt;&gt; from cg_openmm.simulation.rep_exch import *</span>
<span class="sd">    &gt;&gt;&gt; cgmodel = CGModel()</span>
<span class="sd">    &gt;&gt;&gt; replica_energies,replica_positions,replica_state_indices = run_replica_exchange(cgmodel.topology,cgmodel.system,cgmodel.positions)</span>
<span class="sd">    &gt;&gt;&gt; replica_energies,replica_positions,replica_state_indices = process_replica_exchange_data(temperature_list=,output_data=&quot;output.nc&quot;)</span>


<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    
    <span class="c1"># Read the simulation coordinates for individual temperature replicas</span>
    <span class="n">reporter</span> <span class="o">=</span> <span class="n">MultiStateReporter</span><span class="p">(</span><span class="n">output_data</span><span class="p">,</span> <span class="n">open_mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>

    <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;open data time: </span><span class="si">{</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># figure out what the time between output is.</span>
    <span class="c1"># We assume all use the same time step (which i think is required)</span>
    
    <span class="n">mcmove</span> <span class="o">=</span> <span class="n">reporter</span><span class="o">.</span><span class="n">read_mcmc_moves</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">time_interval</span> <span class="o">=</span> <span class="n">mcmove</span><span class="o">.</span><span class="n">n_steps</span><span class="o">*</span><span class="n">mcmove</span><span class="o">.</span><span class="n">timestep</span>

    <span class="n">t3</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;read_mcmc_moves time: </span><span class="si">{</span><span class="n">t3</span><span class="o">-</span><span class="n">t2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># figure out what the temperature list is</span>
    <span class="n">states</span> <span class="o">=</span> <span class="n">reporter</span><span class="o">.</span><span class="n">read_thermodynamic_states</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="n">t4</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;read_thermodynamics_states time: </span><span class="si">{</span><span class="n">t4</span><span class="o">-</span><span class="n">t3</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="n">temperature_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
        <span class="n">temperature_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">temperature</span><span class="p">)</span>

    <span class="n">analyzer</span> <span class="o">=</span> <span class="n">ReplicaExchangeAnalyzer</span><span class="p">(</span><span class="n">reporter</span><span class="p">)</span>
    
    <span class="n">t5</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    
    <span class="p">(</span>
        <span class="n">replica_energies</span><span class="p">,</span>
        <span class="n">unsampled_state_energies</span><span class="p">,</span>
        <span class="n">neighborhoods</span><span class="p">,</span>
        <span class="n">replica_state_indices</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">read_energies</span><span class="p">()</span>
    
    <span class="n">t6</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;read_energies time: </span><span class="si">{</span><span class="n">t6</span><span class="o">-</span><span class="n">t5</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">n_particles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">reporter</span><span class="o">.</span><span class="n">read_sampler_states</span><span class="p">(</span><span class="n">iteration</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">positions</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">temps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">temp</span><span class="o">.</span><span class="n">_value</span> <span class="k">for</span> <span class="n">temp</span> <span class="ow">in</span> <span class="n">temperature_list</span><span class="p">])</span>
    <span class="n">beta_k</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">kB</span> <span class="o">*</span> <span class="n">temps</span><span class="p">)</span>
    <span class="n">n_replicas</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">temperature_list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_replicas</span><span class="p">):</span>
        <span class="n">replica_energies</span><span class="p">[:,</span> <span class="n">k</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*=</span> <span class="n">beta_k</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">t7</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;reduce replica energies time: </span><span class="si">{</span><span class="n">t7</span><span class="o">-</span><span class="n">t6</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="n">total_steps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">replica_energies</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">state_energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_replicas</span><span class="p">,</span> <span class="n">total_steps</span><span class="p">])</span>

    
    <span class="n">t8</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="c1"># there must be some better way to do this as list comprehension.</span>
    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">total_steps</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_replicas</span><span class="p">):</span>
            <span class="n">state_energies</span><span class="p">[</span><span class="n">state</span><span class="p">,</span> <span class="n">step</span><span class="p">]</span> <span class="o">=</span> <span class="n">replica_energies</span><span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">replica_state_indices</span><span class="p">[:,</span> <span class="n">step</span><span class="p">]</span> <span class="o">==</span> <span class="n">state</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">step</span>
            <span class="p">]</span>
            
    <span class="n">t9</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;assign state energies time: </span><span class="si">{</span><span class="n">t9</span><span class="o">-</span><span class="n">t8</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># can run physical-valication on these state_energies</span>
        
    <span class="c1"># Use pymbar timeseries module to detect production period</span>
    <span class="c1"># We can also add in the subsampleCorrelatedData routine</span>
    
    <span class="n">t10</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    
    <span class="n">production_start</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">max_sample_spacing</span> <span class="o">=</span> <span class="mi">1</span>
    
    <span class="k">if</span> <span class="n">detect_equilibration</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_replicas</span><span class="p">))</span>
        <span class="n">subsample_indices</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_replicas</span><span class="p">):</span>
            <span class="n">t0</span><span class="p">[</span><span class="n">state</span><span class="p">],</span> <span class="n">g</span><span class="p">,</span> <span class="n">Neff_max</span> <span class="o">=</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">detectEquilibration</span><span class="p">(</span><span class="n">state_energies</span><span class="p">[</span><span class="n">state</span><span class="p">])</span>
        <span class="n">production_start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">t0</span><span class="p">))</span>
        
        <span class="c1"># Choose the most conservative sample spacing</span>
        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_replicas</span><span class="p">):</span>
            <span class="n">subsample_indices</span><span class="p">[</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">subsampleCorrelatedData</span><span class="p">(</span>
                <span class="n">state_energies</span><span class="p">[</span><span class="n">state</span><span class="p">][</span><span class="n">production_start</span><span class="p">:],</span>
                <span class="n">conservative</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">subsample_indices</span><span class="p">[</span><span class="n">state</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">subsample_indices</span><span class="p">[</span><span class="n">state</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">max_sample_spacing</span><span class="p">:</span>
                <span class="n">max_sample_spacing</span> <span class="o">=</span> <span class="p">(</span><span class="n">subsample_indices</span><span class="p">[</span><span class="n">state</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">subsample_indices</span><span class="p">[</span><span class="n">state</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    
    <span class="n">t11</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;detect equil and subsampling time: </span><span class="si">{</span><span class="n">t11</span><span class="o">-</span><span class="n">t10</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;state    mean energies  variance&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_replicas</span><span class="p">):</span>
        <span class="n">state_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">state_energies</span><span class="p">[</span><span class="n">state</span><span class="p">,</span><span class="n">production_start</span><span class="p">::</span><span class="n">max_sample_spacing</span><span class="p">])</span>
        <span class="n">state_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">state_energies</span><span class="p">[</span><span class="n">state</span><span class="p">,</span><span class="n">production_start</span><span class="p">::</span><span class="n">max_sample_spacing</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">state</span><span class="si">:</span><span class="s2">4d</span><span class="si">}</span><span class="s2">    </span><span class="si">{</span><span class="n">state_mean</span><span class="si">:</span><span class="s2">10.6f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">state_std</span><span class="si">:</span><span class="s2">10.6f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>


    <span class="n">replica_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_replicas</span><span class="p">,</span> <span class="n">total_steps</span><span class="p">,</span> <span class="n">n_particles</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

    <span class="n">t12</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">write_data_file</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_directory</span><span class="p">,</span> <span class="s2">&quot;replica_energies.dat&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">total_steps</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step</span><span class="si">:</span><span class="s2">10d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">sampler_states</span> <span class="o">=</span> <span class="n">reporter</span><span class="o">.</span><span class="n">read_sampler_states</span><span class="p">(</span><span class="n">iteration</span><span class="o">=</span><span class="n">step</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">replica_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_replicas</span><span class="p">):</span>
                <span class="n">replica_positions</span><span class="p">[</span><span class="n">replica_index</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">sampler_states</span><span class="p">[</span><span class="n">replica_index</span><span class="p">]</span><span class="o">.</span><span class="n">positions</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">replica_energies</span><span class="p">[</span><span class="n">replica_index</span><span class="p">,</span><span class="n">replica_index</span><span class="p">,</span><span class="n">step</span><span class="p">]</span><span class="si">:</span><span class="s2">12.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">total_steps</span><span class="p">):</span>
            <span class="n">sampler_states</span> <span class="o">=</span> <span class="n">reporter</span><span class="o">.</span><span class="n">read_sampler_states</span><span class="p">(</span><span class="n">iteration</span><span class="o">=</span><span class="n">step</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">replica_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_replicas</span><span class="p">):</span>
                <span class="n">replica_positions</span><span class="p">[</span><span class="n">replica_index</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">sampler_states</span><span class="p">[</span><span class="n">replica_index</span><span class="p">]</span><span class="o">.</span><span class="n">positions</span>

    <span class="n">t13</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;assign replica positions and optionally write .dat file: </span><span class="si">{</span><span class="n">t13</span><span class="o">-</span><span class="n">t12</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
    <span class="c1"># doing the array operations gets rid of units, convert back to units</span>
    <span class="n">replica_positions</span> <span class="o">=</span> <span class="n">replica_positions</span> <span class="o">*</span> <span class="n">sampler_states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span>

    <span class="n">t14</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">plot_production_only</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="n">plot_replica_exchange_energies</span><span class="p">(</span>
            <span class="n">state_energies</span><span class="p">[:,</span><span class="n">production_start</span><span class="p">:],</span>
            <span class="n">temperature_list</span><span class="p">,</span>
            <span class="n">series_per_page</span><span class="p">,</span>
            <span class="n">time_interval</span><span class="o">=</span><span class="n">time_interval</span><span class="p">,</span>
            <span class="n">time_shift</span><span class="o">=</span><span class="n">production_start</span><span class="o">*</span><span class="n">time_interval</span><span class="p">,</span>
            <span class="n">file_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_directory</span><span class="si">}</span><span class="s2">/rep_ex_ener.pdf&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        
        <span class="n">plot_replica_exchange_energy_histograms</span><span class="p">(</span>
            <span class="n">state_energies</span><span class="p">[:,</span><span class="n">production_start</span><span class="p">:],</span>
            <span class="n">temperature_list</span><span class="p">,</span>
            <span class="n">file_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_directory</span><span class="si">}</span><span class="s2">/rep_ex_ener_hist.pdf&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">plot_replica_exchange_summary</span><span class="p">(</span>
            <span class="n">replica_state_indices</span><span class="p">[:,</span><span class="n">production_start</span><span class="p">:],</span>
            <span class="n">temperature_list</span><span class="p">,</span>
            <span class="n">series_per_page</span><span class="p">,</span>
            <span class="n">time_interval</span><span class="o">=</span><span class="n">time_interval</span><span class="p">,</span>
            <span class="n">time_shift</span><span class="o">=</span><span class="n">production_start</span><span class="o">*</span><span class="n">time_interval</span><span class="p">,</span>
            <span class="n">file_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_directory</span><span class="si">}</span><span class="s2">/rep_ex_states.pdf&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plot_replica_exchange_energies</span><span class="p">(</span>
            <span class="n">state_energies</span><span class="p">,</span>
            <span class="n">temperature_list</span><span class="p">,</span>
            <span class="n">series_per_page</span><span class="p">,</span>
            <span class="n">time_interval</span><span class="o">=</span><span class="n">time_interval</span><span class="p">,</span>
            <span class="n">file_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_directory</span><span class="si">}</span><span class="s2">/rep_ex_ener.pdf&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        
        <span class="n">plot_replica_exchange_energy_histograms</span><span class="p">(</span>
            <span class="n">state_energies</span><span class="p">,</span>
            <span class="n">temperature_list</span><span class="p">,</span>
            <span class="n">file_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_directory</span><span class="si">}</span><span class="s2">/rep_ex_ener_hist.pdf&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">plot_replica_exchange_summary</span><span class="p">(</span>
            <span class="n">replica_state_indices</span><span class="p">,</span>
            <span class="n">temperature_list</span><span class="p">,</span>
            <span class="n">series_per_page</span><span class="p">,</span>
            <span class="n">time_interval</span><span class="o">=</span><span class="n">time_interval</span><span class="p">,</span>
            <span class="n">file_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_directory</span><span class="si">}</span><span class="s2">/rep_ex_states.pdf&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        
    <span class="n">t15</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;plotting time: </span><span class="si">{</span><span class="n">t15</span><span class="o">-</span><span class="n">t14</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;total time elapsed: </span><span class="si">{</span><span class="n">t15</span><span class="o">-</span><span class="n">t1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">replica_energies</span><span class="p">,</span> <span class="n">replica_positions</span><span class="p">,</span> <span class="n">replica_state_indices</span><span class="p">,</span> <span class="n">production_start</span><span class="p">,</span> <span class="n">max_sample_spacing</span><span class="p">)</span></div>


<div class="viewcode-block" id="run_replica_exchange"><a class="viewcode-back" href="../../../index.html#cg_openmm.simulation.rep_exch.run_replica_exchange">[docs]</a><span class="k">def</span> <span class="nf">run_replica_exchange</span><span class="p">(</span>
    <span class="n">topology</span><span class="p">,</span>
    <span class="n">system</span><span class="p">,</span>
    <span class="n">positions</span><span class="p">,</span>
    <span class="n">total_simulation_time</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">unit</span><span class="o">.</span><span class="n">picosecond</span><span class="p">,</span>
    <span class="n">simulation_time_step</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">temperature_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">friction</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">unit</span><span class="o">.</span><span class="n">picosecond</span><span class="p">,</span>
    <span class="n">minimize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">exchange_frequency</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">output_data</span><span class="o">=</span><span class="s2">&quot;output/output.nc&quot;</span><span class="p">,</span>
<span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run a OpenMMTools replica exchange simulation using an OpenMM coarse grained model.</span>
<span class="sd">    </span>
<span class="sd">    :param topology: OpenMM Topology</span>
<span class="sd">    :type topology: `Topology() &lt;https://simtk.org/api_docs/openmm/api4_1/python/classsimtk_1_1openmm_1_1app_1_1topology_1_1Topology.html&gt;`_</span>

<span class="sd">    :param system: OpenMM System()</span>
<span class="sd">    :type system: `System() &lt;https://simtk.org/api_docs/openmm/api4_1/python/classsimtk_1_1openmm_1_1openmm_1_1System.html&gt;`_</span>

<span class="sd">    :param positions: Positions array for the model we would like to test</span>
<span class="sd">    :type positions: `Quantity() &lt;http://docs.openmm.org/development/api-python/generated/simtk.unit.quantity.Quantity.html&gt;`_ ( np.array( [cgmodel.num_beads,3] ), simtk.unit )</span>

<span class="sd">    :param total_simulation_time: Total run time for individual simulations</span>
<span class="sd">    :type total_simulation_time: `SIMTK &lt;https://simtk.org/&gt;`_ `Unit() &lt;http://docs.openmm.org/7.1.0/api-python/generated/simtk.unit.unit.Unit.html&gt;`_</span>

<span class="sd">    :param simulation_time_step: Simulation integration time step</span>
<span class="sd">    :type simulation_time_step: `SIMTK &lt;https://simtk.org/&gt;`_ `Unit() &lt;http://docs.openmm.org/7.1.0/api-python/generated/simtk.unit.unit.Unit.html&gt;`_</span>

<span class="sd">    :param temperature_list: List of temperatures for which to perform replica exchange simulations, default = None</span>
<span class="sd">    :type temperature: List( float * simtk.unit.temperature )</span>

<span class="sd">    :param friction: Langevin thermostat friction coefficient, default = 1 / ps</span>
<span class="sd">    :type friction: `SIMTK &lt;https://simtk.org/&gt;`_ `Unit() &lt;http://docs.openmm.org/7.1.0/api-python/generated/simtk.unit.unit.Unit.html&gt;`_</span>

<span class="sd">    :param minimize: Whether minimization is done before running the simulation</span>
<span class="sd">    :type minimize: bool</span>

<span class="sd">    :param output_data: Name of NETCDF file where we will write simulation data</span>
<span class="sd">    :type output_data: string</span>

<span class="sd">    :param exchange_frequency: Number of time steps between replica exchange attempts, Default = None</span>
<span class="sd">    :type exchange_frequency: int	</span>

<span class="sd">    :param output_data: file to put the output .nc </span>
<span class="sd">    :type output_data: netCDF4 file as generated by OpenMM  </span>

<span class="sd">    :returns:</span>
<span class="sd">        - replica_energies ( `Quantity() &lt;http://docs.openmm.org/development/api-python/generated/simtk.unit.quantity.Quantity.html&gt;`_ ( np.float( [number_replicas,number_simulation_steps] ), simtk.unit ) ) - The potential energies for all replicas at all (printed) time steps</span>
<span class="sd">        - replica_positions ( `Quantity() &lt;http://docs.openmm.org/development/api-python/generated/simtk.unit.quantity.Quantity.html&gt;`_ ( np.float( [number_replicas,number_simulation_steps,cgmodel.num_beads,3] ), simtk.unit ) ) - The positions for all replicas at all (printed) time steps</span>

<span class="sd">        - replica_state_indices ( np.int64( [number_replicas,number_simulation_steps] ), simtk.unit ) - The thermodynamic state assignments for all replicas at all (printed) time steps</span>

<span class="sd">    :Example:</span>

<span class="sd">    &gt;&gt;&gt; from foldamers.cg_model.cgmodel import CGModel</span>
<span class="sd">    &gt;&gt;&gt; from cg_openmm.simulation.rep_exch import *</span>
<span class="sd">    &gt;&gt;&gt; cgmodel = CGModel()</span>
<span class="sd">    &gt;&gt;&gt; replica_energies,replica_positions,replica_state_indices = run_replica_exchange(cgmodel.topology,cgmodel.system,cgmodel.positions)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">simulation_steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">total_simulation_time</span> <span class="o">/</span> <span class="n">simulation_time_step</span><span class="p">))</span>

    <span class="n">exchange_attempts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">simulation_steps</span> <span class="o">/</span> <span class="n">exchange_frequency</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">temperature_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">temperature_list</span> <span class="o">=</span> <span class="p">[((</span><span class="mf">300.0</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">unit</span><span class="o">.</span><span class="n">kelvin</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">10</span><span class="p">)]</span>

    <span class="n">num_replicas</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">temperature_list</span><span class="p">)</span>
    <span class="n">sampler_states</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">thermodynamic_states</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="c1"># Define thermodynamic states.</span>
    <span class="c1"># box_vectors = system.getDefaultPeriodicBoxVectors()</span>
    <span class="k">for</span> <span class="n">temperature</span> <span class="ow">in</span> <span class="n">temperature_list</span><span class="p">:</span>
        <span class="n">thermodynamic_state</span> <span class="o">=</span> <span class="n">openmmtools</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">ThermodynamicState</span><span class="p">(</span>
            <span class="n">system</span><span class="o">=</span><span class="n">system</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span>
        <span class="p">)</span>
        <span class="n">thermodynamic_states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thermodynamic_state</span><span class="p">)</span>
        <span class="n">sampler_states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">openmmtools</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">SamplerState</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># no box vectors, non-periodic system.</span>

    <span class="c1"># Create and configure simulation object.</span>
    <span class="c1"># GHMC is metropolized form of LangevinSplittingDynamicsMove (uses BAOAB velocity verlet)</span>
    <span class="n">move</span> <span class="o">=</span> <span class="n">openmmtools</span><span class="o">.</span><span class="n">mcmc</span><span class="o">.</span><span class="n">LangevinDynamicsMove</span><span class="p">(</span>
        <span class="n">timestep</span><span class="o">=</span><span class="n">simulation_time_step</span><span class="p">,</span>
        <span class="n">collision_rate</span><span class="o">=</span><span class="n">friction</span><span class="p">,</span>
        <span class="n">n_steps</span><span class="o">=</span><span class="n">exchange_frequency</span><span class="p">,</span>
        <span class="n">reassign_velocities</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">simulation</span> <span class="o">=</span> <span class="n">ReplicaExchangeSampler</span><span class="p">(</span>
        <span class="n">mcmc_moves</span><span class="o">=</span><span class="n">move</span><span class="p">,</span>
        <span class="n">number_of_iterations</span><span class="o">=</span><span class="n">exchange_attempts</span><span class="p">,</span>
        <span class="n">replica_mixing_scheme</span><span class="o">=</span><span class="s1">&#39;swap-neighbors&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_data</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">output_data</span><span class="p">)</span>

    <span class="n">reporter</span> <span class="o">=</span> <span class="n">MultiStateReporter</span><span class="p">(</span><span class="n">output_data</span><span class="p">,</span> <span class="n">checkpoint_interval</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">simulation</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">thermodynamic_states</span><span class="p">,</span> <span class="n">sampler_states</span><span class="p">,</span> <span class="n">reporter</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">minimize</span><span class="p">:</span>
        <span class="n">simulation</span><span class="o">.</span><span class="n">minimize</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running replica exchange simulations with OpenMM...&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using a time step of </span><span class="si">{</span><span class="n">simulation_time_step</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">simulation</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Replica exchange simulation failed, try verifying your model/simulation settings.&quot;</span><span class="p">)</span>
        <span class="n">exit</span><span class="p">()</span></div>
   
        
<div class="viewcode-block" id="get_minimum_energy_ensemble"><a class="viewcode-back" href="../../../index.html#cg_openmm.simulation.rep_exch.get_minimum_energy_ensemble">[docs]</a><span class="k">def</span> <span class="nf">get_minimum_energy_ensemble</span><span class="p">(</span>
    <span class="n">topology</span><span class="p">,</span> <span class="n">replica_energies</span><span class="p">,</span> <span class="n">replica_positions</span><span class="p">,</span> <span class="n">ensemble_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get an ensemble of low (potential) energy poses, and write the lowest energy structure to a PDB file if a file_name is provided.</span>
<span class="sd">    </span>
<span class="sd">    :param topology: OpenMM Topology()</span>
<span class="sd">    :type topology: `Topology() &lt;https://simtk.org/api_docs/openmm/api4_1/python/classsimtk_1_1openmm_1_1app_1_1topology_1_1Topology.html&gt;`_</span>
<span class="sd">    </span>
<span class="sd">    :param replica_energies: List of dimension num_replicas X simulation_steps, which gives the energies for all replicas at all simulation steps</span>
<span class="sd">    :type replica_energies: List( List( float * simtk.unit.energy for simulation_steps ) for num_replicas )</span>
<span class="sd">    </span>
<span class="sd">    :param replica_positions: List of positions for all output frames for all replicas</span>
<span class="sd">    :type replica_positions: np.array( ( float * simtk.unit.positions for num_beads ) for simulation_steps )</span>
<span class="sd">    </span>
<span class="sd">    :param file_name: Output destination for PDB coordinates of minimum energy pose, Default = None</span>
<span class="sd">    </span>
<span class="sd">    :returns:</span>
<span class="sd">    - ensemble ( List() ) - A list of poses that are in the minimum energy ensemble.</span>

<span class="sd">    :Example:</span>
<span class="sd">    </span>
<span class="sd">    &gt;&gt;&gt; from foldamers.cg_model.cgmodel import CGModel</span>
<span class="sd">    &gt;&gt;&gt; from cg_openmm.simulation.rep_exch import *</span>
<span class="sd">    &gt;&gt;&gt; cgmodel = CGModel()</span>
<span class="sd">    &gt;&gt;&gt; replica_energies,replica_positions,replica_state_indices = run_replica_exchange(cgmodel.topology,cgmodel.system,cgmodel.positions)</span>
<span class="sd">    &gt;&gt;&gt; ensemble_size = 5</span>
<span class="sd">    &gt;&gt;&gt; file_name = &quot;minimum.pdb&quot;</span>
<span class="sd">    &gt;&gt;&gt; minimum_energy_ensemble = get_minimum_energy_ensemble(cgmodel.topology,replica_energies,replica_positions,ensemble_size=ensemble_size,file_name=file_name)</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the minimum energy structure sampled during the simulation</span>
    <span class="n">ensemble</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ensemble_energies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">replica</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">replica_energies</span><span class="p">)):</span>
        <span class="n">energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">energy</span> <span class="k">for</span> <span class="n">energy</span> <span class="ow">in</span> <span class="n">replica_energies</span><span class="p">[</span><span class="n">replica</span><span class="p">][</span><span class="n">replica</span><span class="p">]])</span>
        <span class="k">for</span> <span class="n">energy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">energies</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ensemble</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ensemble_size</span><span class="p">:</span>
                <span class="n">ensemble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">replica_positions</span><span class="p">[</span><span class="n">replica</span><span class="p">][</span><span class="n">energy</span><span class="p">])</span>
                <span class="n">ensemble_energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">energies</span><span class="p">[</span><span class="n">energy</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">comparison</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ensemble_energies</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">energies</span><span class="p">[</span><span class="n">energy</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ensemble_energies</span><span class="p">[</span><span class="n">comparison</span><span class="p">]:</span>
                        <span class="n">ensemble_energies</span><span class="p">[</span><span class="n">comparison</span><span class="p">]</span> <span class="o">=</span> <span class="n">energies</span><span class="p">[</span><span class="n">energy</span><span class="p">]</span>
                        <span class="n">ensemble</span><span class="p">[</span><span class="n">comparison</span><span class="p">]</span> <span class="o">=</span> <span class="n">replica_positions</span><span class="p">[</span><span class="n">replica</span><span class="p">][</span><span class="n">energy</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">file_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">pose</span> <span class="ow">in</span> <span class="n">ensemble</span><span class="p">:</span>
            <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s2">&quot;re_min_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
            <span class="n">PDBFile</span><span class="o">.</span><span class="n">writeFile</span><span class="p">(</span><span class="n">topology</span><span class="p">,</span> <span class="n">pose</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pose</span> <span class="ow">in</span> <span class="n">ensemble</span><span class="p">:</span>
            <span class="n">PDBFile</span><span class="o">.</span><span class="n">writeFile</span><span class="p">(</span><span class="n">topology</span><span class="p">,</span> <span class="n">pose</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ensemble</span></div>


<div class="viewcode-block" id="plot_replica_exchange_energies"><a class="viewcode-back" href="../../../index.html#cg_openmm.simulation.rep_exch.plot_replica_exchange_energies">[docs]</a><span class="k">def</span> <span class="nf">plot_replica_exchange_energies</span><span class="p">(</span>
    <span class="n">state_energies</span><span class="p">,</span>
    <span class="n">temperature_list</span><span class="p">,</span>
    <span class="n">series_per_page</span><span class="p">,</span>
    <span class="n">time_interval</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">unit</span><span class="o">.</span><span class="n">picosecond</span><span class="p">,</span>
    <span class="n">time_shift</span><span class="o">=</span><span class="mf">0.0</span> <span class="o">*</span> <span class="n">unit</span><span class="o">.</span><span class="n">picosecond</span><span class="p">,</span>    
    <span class="n">file_name</span><span class="o">=</span><span class="s2">&quot;rep_ex_ener.pdf&quot;</span><span class="p">,</span>
    <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the potential energies for a batch of replica exchange trajectories</span>

<span class="sd">    :param state_energies: List of dimension num_replicas X simulation_steps, which gives the energies for all replicas at all simulation steps</span>
<span class="sd">    :type state_energies: List( List( float * simtk.unit.energy for simulation_steps ) for num_replicas )</span>

<span class="sd">    :param temperature_list: List of temperatures for which to perform replica exchange simulations, default = [(300.0 * unit.kelvin).__add__(i * unit.kelvin) for i in range(-20,100,10)]</span>
<span class="sd">    :type temperature: List( float * simtk.unit.temperature )</span>

<span class="sd">    :param time_interval: interval between energy exchanges.</span>
<span class="sd">    :type time_interval: `SIMTK &lt;https://simtk.org/&gt;`_ `Unit() &lt;http://docs.openmm.org/7.1.0/api-python/generated/simtk.unit.unit.Unit.html&gt;`_</span>

<span class="sd">    :param time_shift: amount of time before production period to shift the time axis(default = 0)</span>
<span class="sd">    :type time_shift: `SIMTK &lt;https://simtk.org/&gt;`_ `Unit() &lt;http://docs.openmm.org/7.1.0/api-python/generated/simtk.unit.unit.Unit.html&gt;`_</span>
<span class="sd">    </span>
<span class="sd">    :param file_name: The pathname of the output file for plotting results, default = &quot;replica_exchange_energies.png&quot;</span>
<span class="sd">    :type file_name: str</span>

<span class="sd">    :param legend: Controls whether a legend is added to the plot</span>
<span class="sd">    :type legend: Logical</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">simulation_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">step</span> <span class="o">*</span> <span class="n">time_interval</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">picosecond</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">state_energies</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="p">]</span>
    <span class="p">)</span>
    
    <span class="n">simulation_times</span> <span class="o">+=</span> <span class="n">time_shift</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">picosecond</span><span class="p">)</span>
    
    <span class="c1"># If more than series_per_page replicas, split into separate pages for better visibility</span>
    <span class="n">nmax</span> <span class="o">=</span> <span class="n">series_per_page</span>
    <span class="n">npage</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">temperature_list</span><span class="p">)</span><span class="o">/</span><span class="n">nmax</span><span class="p">))</span>
    
    <span class="k">with</span> <span class="n">PdfPages</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">pdf</span><span class="p">:</span>
        <span class="n">page_num</span><span class="o">=</span><span class="mi">1</span>
        <span class="n">plotted_per_page</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">pyplot</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">temperature_list</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">plotted_per_page</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">nmax</span><span class="p">):</span>
                <span class="n">pyplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">simulation_times</span><span class="p">,</span>
                    <span class="n">state_energies</span><span class="p">[</span><span class="n">state</span><span class="p">,:],</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">plotted_per_page</span> <span class="o">+=</span> <span class="mi">1</span>
                
            <span class="k">if</span> <span class="p">(</span><span class="n">plotted_per_page</span> <span class="o">&gt;=</span> <span class="n">nmax</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">state</span><span class="o">==</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">temperature_list</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
                <span class="c1"># Save and close previous page</span>
                <span class="n">pyplot</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Simulation Time ( Picoseconds )&quot;</span><span class="p">)</span>
                <span class="n">pyplot</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Potential Energy ( kJ / mol )&quot;</span><span class="p">)</span>
                <span class="n">pyplot</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Replica Exchange Simulation&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">legend</span><span class="p">:</span>
                    <span class="n">pyplot</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
                        <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">temperature</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">kelvin</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">temperature</span> <span class="ow">in</span> <span class="n">temperature_list</span><span class="p">[(</span><span class="mi">0</span><span class="o">+</span><span class="p">(</span><span class="n">page_num</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">nmax</span><span class="p">):(</span><span class="n">page_num</span><span class="o">*</span><span class="n">nmax</span><span class="p">)]],</span>
                        <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center left&quot;</span><span class="p">,</span>
                        <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
                        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;T (K)&quot;</span><span class="p">,</span>
                    <span class="p">)</span>  
                
                <span class="n">pdf</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span> <span class="c1"># Save current fig to pdf page</span>
                <span class="n">pyplot</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">plotted_per_page</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">page_num</span> <span class="o">+=</span> <span class="mi">1</span>
                
    <span class="k">return</span></div>
    

<div class="viewcode-block" id="plot_replica_exchange_energy_histograms"><a class="viewcode-back" href="../../../index.html#cg_openmm.simulation.rep_exch.plot_replica_exchange_energy_histograms">[docs]</a><span class="k">def</span> <span class="nf">plot_replica_exchange_energy_histograms</span><span class="p">(</span>
    <span class="n">state_energies</span><span class="p">,</span>
    <span class="n">temperature_list</span><span class="p">,</span>
    <span class="n">file_name</span><span class="o">=</span><span class="s2">&quot;rep_ex_ener_hist.pdf&quot;</span><span class="p">,</span>
    <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the potential energies for a batch of replica exchange trajectories</span>

<span class="sd">    :param state_energies: List of dimension num_replicas X simulation_steps, which gives the energies for all replicas at all simulation steps</span>
<span class="sd">    :type state_energies: List( List( float * simtk.unit.energy for simulation_steps ) for num_replicas )</span>

<span class="sd">    :param temperature_list: List of temperatures for which to perform replica exchange simulations, default = [(300.0 * unit.kelvin).__add__(i * unit.kelvin) for i in range(-20,100,10)]</span>
<span class="sd">    :type temperature: List( float * simtk.unit.temperature )</span>

<span class="sd">    :param file_name: The pathname of the output file for plotting results, default = &quot;replica_exchange_energies.png&quot;</span>
<span class="sd">    :type file_name: str</span>

<span class="sd">    :param legend: Controls whether a legend is added to the plot</span>
<span class="sd">    :type legend: Logical</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">figure</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">8.5</span><span class="p">,</span><span class="mi">11</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">temperature_list</span><span class="p">)):</span>
        <span class="n">n_out</span><span class="p">,</span> <span class="n">bin_edges_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
            <span class="n">state_energies</span><span class="p">[</span><span class="n">state</span><span class="p">,:],</span><span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        
        <span class="n">bin_centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">bin_edges_out</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bin_edges_out</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">bin_centers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">bin_edges_out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">bin_edges_out</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
        
        <span class="n">pyplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span><span class="n">n_out</span><span class="p">,</span><span class="s1">&#39;o-&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
            

    <span class="n">pyplot</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Potential Energy ( kJ / mol )&quot;</span><span class="p">)</span>
    <span class="n">pyplot</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Probability&quot;</span><span class="p">)</span>
    <span class="n">pyplot</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Replica Exchange Energy Histogram&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">legend</span><span class="p">:</span>
        <span class="n">pyplot</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
            <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">temperature</span><span class="o">.</span><span class="n">_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">temperature</span> <span class="ow">in</span> <span class="n">temperature_list</span><span class="p">],</span>
            <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center left&quot;</span><span class="p">,</span>
            <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;T (K)&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">pyplot</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
    <span class="n">pyplot</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span></div>
    

<div class="viewcode-block" id="plot_replica_exchange_summary"><a class="viewcode-back" href="../../../index.html#cg_openmm.simulation.rep_exch.plot_replica_exchange_summary">[docs]</a><span class="k">def</span> <span class="nf">plot_replica_exchange_summary</span><span class="p">(</span>
    <span class="n">replica_states</span><span class="p">,</span>
    <span class="n">temperature_list</span><span class="p">,</span>
    <span class="n">series_per_page</span><span class="p">,</span>
    <span class="n">time_interval</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">unit</span><span class="o">.</span><span class="n">picosecond</span><span class="p">,</span>
    <span class="n">time_shift</span><span class="o">=</span><span class="mf">0.0</span> <span class="o">*</span> <span class="n">unit</span><span class="o">.</span><span class="n">picosecond</span><span class="p">,</span>
    <span class="n">file_name</span><span class="o">=</span><span class="s2">&quot;rep_ex_states.pdf&quot;</span><span class="p">,</span>
    <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the thermodynamic state assignments for individual temperature replicas as a function of the simulation time, in order to obtain a visual summary of the replica exchanges from a OpenMM simulation.</span>

<span class="sd">    :param replica_states: List of dimension num_replicas X simulation_steps, which gives the thermodynamic state indices for all replicas at all simulation steps</span>
<span class="sd">    :type replica_states: List( List( float * simtk.unit.energy for simulation_steps ) for num_replicas )</span>

<span class="sd">    :param temperature_list: List of temperatures for which to perform replica exchange simulations, default = [(300.0 * unit.kelvin).__add__(i * unit.kelvin) for i in range(-20,100,10)]</span>
<span class="sd">    :type temperature: List( float * simtk.unit.temperature )</span>

<span class="sd">    :param time_interval: interval between energy exchanges.</span>
<span class="sd">    :type time_interval: `SIMTK &lt;https://simtk.org/&gt;`_ `Unit() &lt;http://docs.openmm.org/7.1.0/api-python/generated/simtk.unit.unit.Unit.html&gt;`_</span>

<span class="sd">    :param time_shift: amount of time before production period to shift the time axis(default = 0)</span>
<span class="sd">    :type time_shift: `SIMTK &lt;https://simtk.org/&gt;`_ `Unit() &lt;http://docs.openmm.org/7.1.0/api-python/generated/simtk.unit.unit.Unit.html&gt;`_</span>

<span class="sd">    :param file_name: The pathname of the output file for plotting results, default = &quot;replica_exchange_state_transitions.png&quot;</span>
<span class="sd">    :type file_name: str</span>

<span class="sd">    :param legend: Controls whether a legend is added to the plot</span>
<span class="sd">    :type legend: Logical</span>

<span class="sd">    ..warning:: If more than 10 replica exchange trajectories are provided as input data, by default, this function will only plot the first 10 thermodynamic states.  These thermodynamic states are chosen based upon their indices, not their instantaneous temperature (ensemble) assignment.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">simulation_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">step</span> <span class="o">*</span> <span class="n">time_interval</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">picosecond</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">replica_states</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="p">]</span>
    <span class="p">)</span>
    
    <span class="n">simulation_times</span> <span class="o">+=</span> <span class="n">time_shift</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">picosecond</span><span class="p">)</span>
    
    <span class="c1"># If more than series_per_page replicas, split into separate pages for better visibility</span>
    <span class="n">nmax</span> <span class="o">=</span> <span class="n">series_per_page</span>
    <span class="n">npage</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">temperature_list</span><span class="p">)</span><span class="o">/</span><span class="n">nmax</span><span class="p">))</span>
        
    <span class="k">with</span> <span class="n">PdfPages</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">pdf</span><span class="p">:</span>
        <span class="n">page_num</span><span class="o">=</span><span class="mi">1</span>
        <span class="n">plotted_per_page</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">pyplot</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">replica</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">replica_states</span><span class="p">)):</span>
            <span class="n">state_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">state</span><span class="p">))</span> <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">replica_states</span><span class="p">[</span><span class="n">replica</span><span class="p">]])</span>
            
            <span class="k">if</span> <span class="n">plotted_per_page</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">nmax</span><span class="p">):</span>
                <span class="n">pyplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">simulation_times</span><span class="p">,</span>
                    <span class="n">state_indices</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">)</span>
                <span class="n">plotted_per_page</span> <span class="o">+=</span> <span class="mi">1</span>
                
            <span class="k">if</span> <span class="p">(</span><span class="n">plotted_per_page</span> <span class="o">&gt;=</span> <span class="n">nmax</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">replica</span><span class="o">==</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">replica_states</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
                <span class="c1"># Save and close previous page</span>
                <span class="n">pyplot</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Simulation Time ( Picoseconds )&quot;</span><span class="p">)</span>
                <span class="n">pyplot</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Thermodynamic State Index&quot;</span><span class="p">)</span>
                <span class="n">pyplot</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;State Exchange Summary&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">legend</span><span class="p">:</span>
                    <span class="n">pyplot</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">((</span><span class="n">page_num</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">nmax</span><span class="p">,</span><span class="n">page_num</span><span class="o">*</span><span class="n">nmax</span><span class="p">)],</span>
                        <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center left&quot;</span><span class="p">,</span>
                        <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
                        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Replica Index&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                
                <span class="n">pdf</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span> <span class="c1"># Save current fig to pdf page</span>
                <span class="n">pyplot</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">plotted_per_page</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">page_num</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Shirts Group. Project structure based on the Computational Molecular Science Python Cookiecutter version 1.3

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>